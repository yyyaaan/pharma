---
title: "Moi!"
output: 
  flexdashboard::flex_dashboard:
    vertical_layout: scroll
runtime: shiny
---

```{js openInNew}
var links = document.links;

for (var i = 0, linksLength = links.length; i < linksLength; i++) {
   if (links[i].hostname != window.location.hostname) {
       links[i].target = '_blank';
   } 
}
```

```{r setup, include=FALSE}
library(visNetwork)
library(flexdashboard)
library(shiny)
library(tidyverse)
library(DT)
library(shinyWidgets)

getDataType <- function(type = c("char"), lang = "SQL"){
  result <- NULL
  if (lang == "SQL"){
    for(i in 1:length(type)){
      if(type[i] == "Char") result <- c(result, "Char(100)")
      else if(type[i] == "Num") result <- c(result, "   Num(8)")
      else result <- c(result, "/*ERROR*/")
    }
  }
  if (lang == "SAS"){
    for(i in 1:length(type)){
      if(type[i] == "Char") result <- c(result, 'length=$100')
      else if(type[i] == "Num") result <- c(result, 'length=8   ')
      else result <- c(result, "/*ERROR*/")
    }
  }
  result
}

getCode <- function(the_table, lang = "SQL"){

  if(lang == "SQL") return(
    the_table %>% 
      mutate(Sql = paste0('\t/*', str_pad(Core, 4) ,'*/  ', 
                          str_pad(`Variable Name`, 15, "right"), 
                          getDataType(Type), 
                          ' "', `Variable Label`, '"')) %>%
      pull(Sql) %>% 
      paste(collapse = ", \n") %>% 
      paste("creat table attrib(\n", ., "\n)")
  )

  if(lang == "SAS") return(
    the_table %>% 
      mutate(Sas = paste0('\t/*',str_pad(Core, 4) ,'*/  ', 
                          str_pad(`Variable Name`, 15, "right"), 
                          getDataType(Type, "SAS"),
                          '  label="', `Variable Label`, '"')) %>%
      pull(Sas) %>% 
      paste(collapse = "\n") %>% 
      paste('data shell;\n\tattrib\n', . ,'\n\t;\n\tretain _character_ ""; stop;\nrun;')
  )
}

```

Cheatsheet {data-orientation=columns}
=======================================================================

Column
-----------------------------------------------------------------------

### R Links

- [R-Markdown Dashboard](https://rmarkdown.rstudio.com/lesson-12.html) | [R-Markdown Webstie](https://rmarkdown.rstudio.com/rmarkdown_websites.html)

- [R-Markdown Styling](https://rmarkdown.rstudio.com/html_document_format.html#appearance_and_style) | [Bootstrap Themes](https://bootswatch.com/)

- [Shiny Server Manual](http://docs.rstudio.com/shiny-server/)

### Tidyverse

Modify, Subset, Keep/Drop, Extract, Summarize
<p><pre>
datatable %>% 
  mutate(new_var = fun(old_vars)) %>%
  filter(var = cond) %>%
  select(var1, var2) %>%  
  pull(var1) %>% 
  summarize_at(c("var1", "var2"), fun)
</pre></p>




Column
-----------------------------------------------------------------------

### SAS Documentations

- [SAS Procedures](https://go.documentation.sas.com/?cdcId=pgmsascdc&cdcVersion=9.4_3.4&docsetId=allprodsproc&docsetTarget=procedures.htm&locale=en)

- [SAS Data Steps](https://go.documentation.sas.com/?cdcId=pgmsascdc&cdcVersion=9.4_3.4&docsetId=lestmtsref&docsetTarget=p08st7rzfn0dgin1fml8hq40hlho.htm&locale=en)

- [Functions](https://go.documentation.sas.com/?cdcId=pgmsascdc&cdcVersion=9.4_3.4&docsetId=lefunctionsref&docsetTarget=n01f5qrjoh9h4hn1olbdpb5pr2td.htm&locale=en)


### Working with Formats

<p><pre>
ENDDT = input(substr(str, 1, 10), yymmdd10.);
format ENDDT yymmdd10.;
ADY = intck('day', STARTDT, ENDDT);
</pre></p>

### Working with first. and count

<p><pre>
 count + 1; 
 by USUBJID;
 if first.USUBJID then count = 1;
 SEQ = count;
</pre></p>

### PROC output styles

<p><pre>
PROC MEANS noprint data=input;
	var bmi;
	by cohort;
	output out = output (drop = _freq_ _type_);
PROC FREQ data=input
  table var1 * var2 / out = output;
RUN;
</pre></p>

### PROC Transpose wide->long

<p><pre>
PROC TRANSPOSE data=input 
               out=output (drop=_NAME_ _label_);
	by [the combination to identify];
	id [move to column];
	var [column to be transposed to row];
RUN;
</pre></p>







Column
-----------------------------------------------------------------------

### CDISC.org References

- [SDTMIG v3.3](https://www.cdisc.org/standards/foundational/sdtmig/sdtmig-v3-3) | [v3.2 pdf](https://www.cdisc.org/system/files/members/standard/foundational/sdtmig/sdtmig_20v3.2_20noportfolio.pdf)

- [SDTM v1.7](https://www.cdisc.org/standards/foundational/sdtm/sdtm-v1-7)

- [SDTM Controlled Terminology](https://evs.nci.nih.gov/ftp1/CDISC/SDTM/SDTM%20Terminology.html)

- [CDISC Glossary](https://www.cdisc.org/system/files/members/standard/foundational/glossary/CDISC%20Glossary%20v11.pdf)

<center>
[AE](https://www.cdisc.org/standards/foundational/sdtmig/sdtmig-v3-3#Adverse+Events) | [EX](https://www.cdisc.org/standards/foundational/sdtmig/sdtmig-v3-3#Exposure)
</center>

### Important Notes

[relative timing](https://www.cdisc.org/standards/foundational/sdtmig/sdtmig-v3-3#Use+of+Relative+Timing+Variables) | --STRF -- ENRF --STRTPT --STTPT --ENRTPT --ENTPT 
<br />
BEFORE DURING DURING/AFTER AFTER U (=unkonwn) Ongoing Prior


GCP {data-orientation=rows}
=======================================================================

Row {data-height=600}
-----------------------------------------------------------------------

### SDTM at a Glance

```{r}
keys <- c("Data Class", "Variable Roles", "Core Variables")

grp01 <- data.frame(id = 1:3,
                   label = keys,
                   title = c("define tables", "define variables", "some "),
                   group = keys,
                   shape = c("database", "circle", "star"))
grp11 <- data.frame(id = 11:16,
                   label = c("Inteventions",  "Events", "Findings", "Domain", "Trial Design", "Relationship"),
                   title = NA,
                   group = keys[1],
                   shape = "ellipse")
grp12 <- data.frame(id = 21:24,
                   label = c("Identifier", "Topic", "Timing", "Qualifier"),
                   title = NA,
                   group = keys[2],
                   shape = "ellipse")
grp13 <- data.frame(id = 31:33,
                   label = c("Required", "Expected", "Permissible"),
                   title = NA,
                   group = keys[3], 
                   shape = "text")
grp21 <- data.frame(id = 101:114,
                   label = c("CM", "EX", "AE", "DS", "VS", "PE", "DM", "CO", "SV", "TA", "TI", "TV", "RELREC", "SUPP--"),
                   title = c("CM Conmeds", "EX Exposure", "AE Adverse Events", "DS Disposition Events", "VS Vital Signs", "PE Pysical Exam", "DM Demographics", "CO Comments", "SV Subject Visits", "TA Trial Arms", "TI Trial Inclusion", "TV Trial Visits", "RELREC Related Records", "SUPP-- Supplemental Qualifiers"),
                   group = "- tables",
                   shape = "box")
grp22 <- data.frame(id = 201:212,
                    label = c("STUDYID", "USUBJID", "--SEQ", "LBTEST", "AETERM", "CMTRT", "LBDTC", "AESTDTC", "EXENDTC", "LBORRES", "AESEV", "CMDOSE"),
                    title = c("STUDYID Study ID", "USUBJID Subject ID", "--SEQ Sequence ID", "LBTEST Lab Test Name", "AETERM Adverse Event Term", "CMTRT Reported Drug Name", "LBDTC Lab Assessment Date", "AESTDTC Adverse Event Start Date", "EXENDTC Exposure End Date", "LBORRES Lab Test Result", "AESEV Adverse Event Severity", "CMDOSE Conmed Dose"),
                    group = "- variables",
                    shape = "box")

nodes <- rbind(grp01, grp11, grp12, grp13, grp21, grp22)
edges <- data.frame(from = c(rep(1, 6), rep(2, 4), rep(3, 3),
                             rep(11,2), rep(12,2), rep(13,2), rep(14,3), rep(15,3), rep(16,2),
                             rep(21,3), rep(22,3), rep(23,3), rep(24,3)),
                    to   = c(11:16, 21:24, 31:33,
                             101:114,
                             201:212))

visNetwork(nodes, edges, width = "100%", height = "600px") %>%
  visOptions(highlightNearest = list(enabled = T, hover = T), 
             selectedBy = "group")  %>%
  visLayout(randomSeed = 69)
```


### Something to Cover

to be furnished


SDTM
=======================================================================

Column {.sidebar}
-----------------------------------------------------------------------

```{r}
tables <- readRDS("sdtm_domain.rds")
catlog <- tables[[1]]

pickerInput("sdtm_domain", "Domains",
            choices = catlog %>% 
              select(Class, Name) %>% mutate(id = 1:nrow(catlog)) %>% 
              spread(key = "Class", value = "Name") %>% select(-id) %>%
              as.list() %>% lapply(function(x) x[!is.na(x)]),
            options = list(`live-search` = TRUE))

renderText(paste(nrow(tables[[catlog$index[which(catlog$Name == input$sdtm_domain)]]]), "variables"))
renderText(tables[[catlog$index[which(catlog$Name == input$sdtm_domain)]]] %>%
             count(Core) %>%
             mutate(text = paste(Core, n)) %>%
             pull(text) %>%
             paste(collapse = " | "))

```

<hr />

```{r label}

```

<hr />

All variable names (RETAIN)

```{r}
renderPrint(
  tables[[catlog$index[which(catlog$Name == input$sdtm_domain)]]] %>%
    pull(1) %>%
    paste(collapse = " ") %>%
    cat()
)

renderUI(tags$a("SDTM Link on CDISC", 
                href =  paste0("https://www.cdisc.org/standards/foundational/sdtmig/sdtmig-v3-3#",
                               input$sdtm_domain %>% substr(4,99) %>% str_replace_all(" ", "+")),
                class = "btn btn-default", target="_blank"))
```

<hr />


Based on [SDTMIG v3.3](https://www.cdisc.org/standards/foundational/sdtmig/sdtmig-v3-3)

Column
-----------------------------------------------------------------------

### Tables

```{r}
dropdownButton(
  tags$h3("Generate Code"),
  
  awesomeCheckboxGroup(inputId = "sdtm_core", label = "",
                       choices = c("Req", "Perm", "Exp"), selected = c("Req", "Exp"),
                       inline =  TRUE),
  
  radioGroupButtons(inputId = "lang", label = "", 
                    choices = c("SQL", "SAS"), status = "primary"),
  
  tags$hr(),
  
  renderPrint(
      tables[[catlog$index[which(catlog$Name == input$sdtm_domain)]]] %>% 
        filter(Core %in% input$sdtm_core) %>%
        getCode(input$lang) %>%
        cat()
  ),
  
  circle = F, status = "primary", label = "Get Code", width = "699px"
)

```

```{r}
renderDT(tables[[catlog$index[which(catlog$Name == input$sdtm_domain)]]],
                    options = list(pageLength = 999, dom = 'ft'))
```

<center>= = = end = = =</center>
